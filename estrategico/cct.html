<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CCT ‚Äî Centro de Contenido Territorial (Abasolo)</title>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      /* =========================================================
       CCT-Abasolo WAR ROOM (SUPERLUJO) ‚Äî tokens
       ========================================================= */
      :root {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --muted: rgba(17, 24, 39, 0.62);
        --text: #111827;
        --line: rgba(17, 24, 39, 0.1);
        --shadow: 0 18px 45px rgba(0, 0, 0, 0.16);
        --shadow-soft: 0 10px 22px rgba(0, 0, 0, 0.12);

        /* Accent (sin guinda): azul petr√≥leo ejecutivo */
        --accent: #1f4b5a;
        --accent-2: #0f2f3a;
        --accent-soft: rgba(31, 75, 90, 0.1);

        /* Sem√°foros sobrios */
        --ok: #14532d;
        --ok-bg: rgba(20, 83, 45, 0.1);
        --warn: #7c4a03;
        --warn-bg: rgba(124, 74, 3, 0.1);
        --bad: #7f1d1d;
        --bad-bg: rgba(127, 29, 29, 0.1);

        --code-bg: #0b1020;
        --code-text: #e7e7e7;

        --radius: 18px;
        --radius-2: 14px;
        --radius-3: 12px;

        --pad: 14px;
        --pad2: 12px;
        --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family: var(--font);
        background: var(--bg);
        color: var(--text);
      }
      * {
        box-sizing: border-box;
      }

      /* =========================================================
       Layout war room
       ========================================================= */
      .wr {
        position: fixed;
        inset: 0;
        display: grid;
        grid-template-columns: 1.45fr 1fr;
        gap: 12px;
        padding: 12px;
      }

      @media (max-width: 1100px) {
        .wr {
          grid-template-columns: 1fr;
        }
      }

      .mapWrap {
        position: relative;
        border-radius: var(--radius);
        overflow: hidden;
        background: #fff;
        border: 1px solid var(--line);
        box-shadow: var(--shadow-soft);
        min-height: 52vh;
      }

      #cctMap {
        height: 100%;
        width: 100%;
      }

      .panel {
        position: relative;
        border-radius: var(--radius);
        background: var(--panel);
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 40vh;
        animation: slideIn 0.22s ease-out both;
      }

      @keyframes slideIn {
        from {
          transform: translateY(6px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .pHeader {
        padding: 14px 16px;
        border-bottom: 1px solid var(--line);
        background: linear-gradient(
          180deg,
          rgba(31, 75, 90, 0.06),
          rgba(255, 255, 255, 0)
        );
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .brand {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 250px;
      }

      .title {
        font-size: 15px;
        font-weight: 950;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .lockPill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 900;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.8);
      }

      .subtitle {
        font-size: 12px;
        color: var(--muted);
      }

      .topActions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .btn {
        border: 1px solid var(--line);
        background: #fff;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 900;
        font-size: 12px;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.1);
      }

      .btnPrimary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }
      .btnGhost {
        background: rgba(255, 255, 255, 0.65);
      }
      .btnDanger {
        background: rgba(127, 29, 29, 0.06);
        border-color: rgba(127, 29, 29, 0.2);
        color: var(--bad);
      }

      /* =========================================================
       Map HUD
       ========================================================= */
      .hud {
        position: absolute;
        left: 12px;
        top: 12px;
        z-index: 9999;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .kpi {
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(6px);
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 10px 12px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 12px;
        font-weight: 900;
      }

      .kpi small {
        font-weight: 800;
        color: var(--muted);
        margin-right: 6px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        font-size: 11px;
        font-weight: 950;
        letter-spacing: 0.2px;
        background: #fff;
        white-space: nowrap;
      }
      .chipOk {
        color: var(--ok);
        background: var(--ok-bg);
        border-color: rgba(20, 83, 45, 0.22);
      }
      .chipWarn {
        color: var(--warn);
        background: var(--warn-bg);
        border-color: rgba(124, 74, 3, 0.22);
      }
      .chipBad {
        color: var(--bad);
        background: var(--bad-bg);
        border-color: rgba(127, 29, 29, 0.22);
      }

      .miniTools {
        position: absolute;
        right: 12px;
        top: 12px;
        z-index: 9999;
        display: flex;
        gap: 8px;
      }

      .miniBtn {
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 11px;
        cursor: pointer;
        font-weight: 950;
        font-size: 12px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
        transition: transform 0.12s ease;
      }
      .miniBtn:hover {
        transform: translateY(-1px);
      }

      /* =========================================================
       Tabs
       ========================================================= */
      .tabs {
        display: flex;
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        background: #fff;
      }

      .tab {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        font-weight: 950;
        font-size: 12px;
        color: rgba(17, 24, 39, 0.85);
        transition: background 0.12s ease, transform 0.12s ease;
      }

      .tab:hover {
        transform: translateY(-1px);
      }
      .tab.active {
        background: var(--accent-soft);
        border-color: rgba(31, 75, 90, 0.26);
        color: var(--accent-2);
      }

      .pBody {
        padding: 12px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
        background: linear-gradient(
          180deg,
          rgba(31, 75, 90, 0.04),
          rgba(255, 255, 255, 0)
        );
      }

      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 1100px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid var(--line);
        border-radius: var(--radius-2);
        padding: var(--pad2);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
      }

      .cardTitle {
        font-weight: 950;
        font-size: 12px;
        color: rgba(17, 24, 39, 0.88);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .formGrid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }

      @media (max-width: 1100px) {
        .formGrid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .field label {
        font-size: 11px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
        font-weight: 900;
      }

      .value,
      .select,
      .input {
        width: 100%;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        font-size: 12px;
        font-weight: 900;
        background: #fff;
      }

      .value {
        background: #f3f4f6;
        border-color: rgba(17, 24, 39, 0.08);
        color: rgba(17, 24, 39, 0.92);
      }

      .mono {
        background: var(--code-bg);
        color: var(--code-text);
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 12px;
        min-height: 210px;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New";
        font-size: 11px;
        line-height: 1.5;
      }

      .rowActions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .hint {
        font-size: 11px;
        color: var(--muted);
        margin-top: 10px;
        line-height: 1.35;
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .histItem {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
      }
      .histHead {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .histHead .hTitle {
        font-weight: 950;
        font-size: 12px;
      }
      .histHead .hMeta {
        font-size: 11px;
        color: var(--muted);
        font-weight: 900;
        white-space: nowrap;
      }
      .histBtns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .smallBtn {
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 950;
        font-size: 11px;
        cursor: pointer;
      }

      /* =========================================================
       Auth modal (PIN)
       ========================================================= */
      .authBackdrop {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.56);
        z-index: 20000;
      }
      .auth {
        width: min(440px, calc(100vw - 32px));
        background: #fff;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 22px 60px rgba(0, 0, 0, 0.35);
        padding: 16px;
      }
      .auth h2 {
        margin: 0 0 6px;
        font-size: 16px;
        font-weight: 950;
      }
      .auth p {
        margin: 0 0 12px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 800;
      }
      .auth input {
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        font-weight: 950;
        letter-spacing: 2px;
        font-size: 12px;
      }
      .auth .row {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }
      .auth .msg {
        margin-top: 10px;
        font-size: 12px;
        color: var(--bad);
        font-weight: 900;
        display: none;
      }

      /* Leaflet tweaks */
      .leaflet-control-zoom a {
        border-radius: 10px !important;
      }
    </style>
  </head>

  <body>
    <div class="wr">
      <!-- MAP -->
      <div class="mapWrap" id="mapWrap">
        <div class="hud">
          <div class="kpi">
            <small>SECCI√ìN</small><span id="hudSec">‚Äî</span>
          </div>
          <div class="kpi">
            <small>TIPO</small><span id="hudTipo" class="chip">‚Äî</span>
          </div>
          <div class="kpi">
            <small>MARGEN</small><span id="hudMargen">‚Äî</span>
          </div>
          <div class="kpi">
            <small>CONECTIVIDAD</small><span id="hudConn" class="chip">‚Äî</span>
          </div>
        </div>

        <div class="miniTools">
          <button class="miniBtn" id="btnFitAll" type="button" title="Ver todo">
            Ver todo
          </button>
          <button
            class="miniBtn"
            id="btnClearSel"
            type="button"
            title="Limpiar selecci√≥n"
          >
            Limpiar
          </button>
        </div>

        <div id="cctMap"></div>
      </div>

      <!-- PANEL -->
      <div class="panel" id="panel">
        <div class="pHeader">
          <div class="brand">
            <div class="title">
              CCT ‚Äî Centro de Contenido Territorial ¬∑ Abasolo
              <span class="lockPill" id="lockPill">üîí LOCKED</span>
            </div>
            <div class="subtitle">
              War Room ¬∑ Selecciona una secci√≥n en el mapa para operar.
            </div>
          </div>

          <div class="topActions">
            <button class="btn btnGhost" id="btnGoPortal" type="button">
              Ir a portal
            </button>
            <button class="btn btnDanger" id="btnLogout" type="button">
              Cerrar sesi√≥n
            </button>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="brief" type="button">
            Brief IA
          </button>
          <button class="tab" data-tab="diag" type="button">Diagn√≥stico</button>
          <button class="tab" data-tab="plan" type="button">
            Plan de acci√≥n
          </button>
          <button class="tab" data-tab="hist" type="button">Historial</button>
        </div>

        <div class="pBody" id="tab_brief">
          <div class="card">
            <div class="cardTitle">
              <span>A) Contexto y controles</span>
              <span class="chip" id="chipStatus">Selecciona secci√≥n</span>
            </div>

            <div class="formGrid">
              <div class="field">
                <label>Municipio</label>
                <div class="value" id="cctMunicipio">ABASOLO</div>
              </div>

              <div class="field">
                <label>Secci√≥n</label>
                <select class="select" id="selSeccion"></select>
              </div>

              <div class="field">
                <label>Etapa</label>
                <select class="select" id="selEtapa">
                  <option value="PRECAMPA√ëA">PRECAMPA√ëA</option>
                  <option value="CAMPA√ëA">CAMPA√ëA</option>
                </select>
              </div>

              <div class="field">
                <label>Enfoque</label>
                <select class="select" id="selEnfoque">
                  <option value="escucha">Escucha</option>
                  <option value="posicionamiento">Posicionamiento</option>
                  <option value="movilizacion">Movilizaci√≥n</option>
                  <option value="reconexion">Reconexi√≥n</option>
                </select>
              </div>

              <div class="field">
                <label>Formato</label>
                <select class="select" id="selFormato">
                  <option value="evento">Evento</option>
                  <option value="video_corto">Video corto</option>
                  <option value="publicacion">Publicaci√≥n</option>
                </select>
              </div>

              <div class="field">
                <label>Tono</label>
                <select class="select" id="selTono">
                  <option value="cercano">Cercano</option>
                  <option value="firme">Firme</option>
                  <option value="inspirador">Inspirador</option>
                </select>
              </div>

              <div class="field">
                <label>Tipo de secci√≥n</label>
                <div class="value" id="valTipo">‚Äî</div>
              </div>

              <div class="field">
                <label>Margen (A 2024)</label>
                <div class="value" id="valMargen">‚Äî</div>
              </div>
            </div>

            <div class="rowActions">
              <button class="btn btnPrimary" id="btnGenerar" type="button">
                Generar Payload + Prompt + Brief
              </button>
              <button class="btn" id="btnCopyPayload" type="button">
                Copiar Payload
              </button>
              <button class="btn" id="btnCopyPrompt" type="button">
                Copiar Prompt
              </button>
              <button class="btn" id="btnCopyBrief" type="button">
                Copiar Brief Ejecutivo
              </button>
              <button class="btn" id="btnGuardar" type="button">
                Guardar en historial
              </button>
            </div>

            <div class="hint">
              Tip: Selecciona secci√≥n con clic en mapa ‚Üí zoom + highlight
              autom√°tico. El ‚ÄúBrief Ejecutivo‚Äù est√° pensado para el candidato
              (sin tecnicismos).
            </div>
          </div>

          <div class="grid2">
            <div class="card">
              <div class="cardTitle">B) Payload (JSON)</div>
              <pre class="mono" id="outPayload"></pre>
              <div class="rowActions">
                <button class="btn" id="btnPdfEjecutivo" type="button">
                  Exportar PDF Ejecutivo
                </button>
                <button class="btn" id="btnPdfCompleto" type="button">
                  Exportar PDF Completo
                </button>
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">C) Prompt Maestro (listo para IA)</div>
              <pre class="mono" id="outPrompt"></pre>
            </div>
          </div>

          <div class="card">
            <div class="cardTitle">D) Brief Ejecutivo (para candidato)</div>
            <pre class="mono" id="outBrief"></pre>
          </div>
        </div>

        <div class="pBody" id="tab_diag" style="display: none">
          <div class="grid2">
            <div class="card">
              <div class="cardTitle">Electoral ¬∑ Resumen</div>
              <div class="formGrid">
                <div class="field">
                  <label>Ganador (A 2024)</label>
                  <div class="value" id="dGanador">‚Äî</div>
                </div>
                <div class="field">
                  <label>Participaci√≥n (aprox)</label>
                  <div class="value" id="dPart">‚Äî</div>
                </div>
                <div class="field">
                  <label>Fragmentaci√≥n</label>
                  <div class="value" id="dFrag">‚Äî</div>
                </div>
                <div class="field">
                  <label>Competitividad</label>
                  <div class="value" id="dComp">‚Äî</div>
                </div>
              </div>
              <div class="hint">
                Nota: si tu A.json no trae ‚Äúparticipaci√≥n‚Äù, se calcula como
                TOTAL/LN cuando exista LN.
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">Socioecon√≥mico ¬∑ Etiquetas</div>
              <div class="formGrid">
                <div class="field">
                  <label>Perfil demogr√°fico</label>
                  <div class="value" id="sDemo">‚Äî</div>
                </div>
                <div class="field">
                  <label>Nivel educativo</label>
                  <div class="value" id="sEdu">‚Äî</div>
                </div>
                <div class="field">
                  <label>Presi√≥n econ√≥mica</label>
                  <div class="value" id="sEco">‚Äî</div>
                </div>
                <div class="field">
                  <label>Conectividad</label>
                  <div class="value" id="sConn">‚Äî</div>
                </div>
                <div class="field">
                  <label>D√©ficit servicios</label>
                  <div class="value" id="sServ">‚Äî</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardTitle">Lectura r√°pida (para equipo)</div>
            <pre class="mono" id="diagNarrativa"></pre>
          </div>
        </div>

        <div class="pBody" id="tab_plan" style="display: none">
          <div class="card">
            <div class="cardTitle">
              Plan de acci√≥n sugerido (operaci√≥n + redes)
            </div>
            <pre class="mono" id="planTexto"></pre>
            <div class="rowActions">
              <button class="btn" id="btnCopyPlan" type="button">
                Copiar plan
              </button>
            </div>
          </div>
        </div>

        <div class="pBody" id="tab_hist" style="display: none">
          <div class="card">
            <div class="cardTitle">
              <span>Historial CCT (local)</span>
              <span class="chip" id="histCount">0</span>
            </div>
            <div class="rowActions">
              <button class="btn" id="btnHistRefresh" type="button">
                Actualizar
              </button>
              <button class="btn btnDanger" id="btnHistClear" type="button">
                Borrar todo
              </button>
            </div>
            <div class="hint">
              Se guarda en el navegador (localStorage). Ideal para war room
              interno.
            </div>
          </div>

          <div class="list" id="histList"></div>
        </div>
      </div>
    </div>

    <!-- AUTH MODAL -->
    <div class="authBackdrop" id="authBackdrop" style="display: none">
      <div class="auth">
        <h2>Acceso restringido ‚Äî CCT</h2>
        <p>Herramienta interna. Ingresa tu PIN para continuar.</p>
        <input
          id="pinInput"
          type="password"
          inputmode="numeric"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          maxlength="16"
        />
        <div class="row">
          <button class="btn btnPrimary" id="btnEnter" type="button">
            Entrar
          </button>
          <button class="btn btnDanger" id="btnExit" type="button">
            Salir
          </button>
        </div>
        <div class="msg" id="authMsg">PIN incorrecto.</div>
      </div>
    </div>

    <!-- libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <script>
      /**************************************************************
       * CONFIG (Abasolo)
       **************************************************************/
      const CCT_CFG = {
        municipio: "ABASOLO",
        paths: {
          geo: "data/geo/secciones_abasolo.geojson",
          electoralA: "data/electoral/A.json",
          socio: "data/Datos_Socioeconomicos.json",
        },

        // Seguridad (PIN hashed SHA-256)
        // PIN actual (ejemplo) = "cct-2026-abasolo"
        // Si quieres cambiarlo, dime el PIN nuevo y te paso el hash ya hecho,
        // o genera con: await crypto.subtle.digest('SHA-256', new TextEncoder().encode('PIN'))
        pinHashHex:
          "fde02b449a2b7c0d386e829c6e365f62058a1aa4e1fa6a18e517b7b72a85168f",

        sessionKey: "CCT_AUTH_OK",
        idleMinutes: 30,

        // Clasificaci√≥n competitividad (margen en puntos)
        baseMarginPts: 8,
        recMarginPts: -8,
      };

      /**************************************************************
       * Utils
       **************************************************************/
      const $ = (id) => document.getElementById(id);

      function toNum(v) {
        if (v === null || v === undefined) return 0;
        const n = Number(String(v).replace(/,/g, "").trim());
        return Number.isFinite(n) ? n : 0;
      }

      function copyText(text) {
        if (!text) return;
        navigator.clipboard?.writeText(text).catch(() => {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        });
      }

      function nowISO() {
        const d = new Date();
        const pad = (x) => String(x).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function setChip(el, label, type) {
        el.textContent = label || "‚Äî";
        el.classList.remove("chipOk", "chipWarn", "chipBad");
        if (type === "ok") el.classList.add("chipOk");
        if (type === "warn") el.classList.add("chipWarn");
        if (type === "bad") el.classList.add("chipBad");
      }

      function classifyTipoSeccion(margenPts) {
        if (margenPts >= CCT_CFG.baseMarginPts) return "BASE";
        if (margenPts <= CCT_CFG.recMarginPts) return "RECUPERACION";
        return "COMPETIDA";
      }

      function tipoChip(tipo) {
        if (tipo === "BASE") return ["BASE", "ok"];
        if (tipo === "RECUPERACION") return ["RECUPERACI√ìN", "bad"];
        return ["COMPETIDA", "warn"];
      }

      /**************************************************************
       * Auth (PIN SHA-256) + Idle timeout
       **************************************************************/
      let idleTimer = null;

      function isAuthed() {
        return sessionStorage.getItem(CCT_CFG.sessionKey) === "1";
      }
      function setAuthed() {
        sessionStorage.setItem(CCT_CFG.sessionKey, "1");
      }
      function clearAuth() {
        sessionStorage.removeItem(CCT_CFG.sessionKey);
      }
      function showAuth(show) {
        $("authBackdrop").style.display = show ? "flex" : "none";
        $("lockPill").textContent = show ? "üîí LOCKED" : "üü¢ UNLOCKED";
      }

      async function sha256Hex(str) {
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map((b) => b.toString(16).padStart(2, "0")).join("");
      }

      function resetIdle() {
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
          clearAuth();
          showAuth(true);
          $("authMsg").style.display = "none";
          $("pinInput").value = "";
        }, CCT_CFG.idleMinutes * 60 * 1000);
      }

      function bindIdle() {
        ["mousemove", "keydown", "mousedown", "touchstart", "scroll"].forEach(
          (ev) => {
            window.addEventListener(
              ev,
              () => {
                if (isAuthed()) resetIdle();
              },
              { passive: true }
            );
          }
        );
      }

      function goPortal() {
        window.location.href = "portal.html";
      }

      $("btnGoPortal").addEventListener("click", goPortal);
      $("btnExit").addEventListener("click", goPortal);

      $("btnLogout").addEventListener("click", () => {
        clearAuth();
        showAuth(true);
      });

      $("btnEnter").addEventListener("click", async () => {
        const pin = ($("pinInput").value || "").trim();
        const h = await sha256Hex(pin);
        const ok = h === CCT_CFG.pinHashHex;
        $("authMsg").style.display = ok ? "none" : "block";
        if (ok) {
          setAuthed();
          showAuth(false);
          resetIdle();
        }
      });

      bindIdle();
      showAuth(!isAuthed());
      if (isAuthed()) resetIdle();

      /**************************************************************
       * Data cache
       **************************************************************/
      const CCT_DATA = {
        geo: null,
        electoralA: null,
        socio: null,
      };

      async function loadAll() {
        const [geo, electAraw, socio] = await Promise.all([
          fetch(CCT_CFG.paths.geo).then((r) => r.json()),
          fetch(CCT_CFG.paths.electoralA).then((r) => r.json()),
          fetch(CCT_CFG.paths.socio).then((r) => r.json()),
        ]);

        CCT_DATA.geo = geo;
        CCT_DATA.socio = socio;

        // ‚úÖ ADAPTADOR: A.json (meta + secciones + years) -> formato CCT por secci√≥n
        const out = {};
        const secciones = electAraw?.secciones || {};

        for (const [sec, obj] of Object.entries(secciones)) {
          const y2024 = obj?.["2024"] || {};
          // Partidos desde meta (si existe) o desde llaves 2024
          const parties = (
            electAraw?.meta?.parties || Object.keys(y2024)
          ).filter((k) => !["VOTOS", "LN"].includes(k));

          // Construimos el record compatible con el CCT (prefijo 24A_)
          const rec = {};
          for (const p of parties) rec[`24A_${p}`] = y2024[p] ?? 0;

          rec["24A_TOTAL"] = y2024["VOTOS"] ?? 0;
          rec["24A_LN"] = y2024["LN"] ?? 0;

          // Ganador (si no existe, el CCT lo calcula igual, pero lo dejamos listo)
          let ganador = "‚Äî";
          let max = -1;
          for (const p of parties) {
            const v = Number(y2024[p] ?? 0);
            if (v > max) {
              max = v;
              ganador = p;
            }
          }
          rec["GANADOR_24A"] = ganador;

          out[String(sec)] = rec;
        }

        CCT_DATA.electoralA = out;
      }

      /**************************************************************
       * Robust electoral detection (A 2024)
       **************************************************************/
      function detectA2024Prefix(rec) {
        const candidates = [
          "24A_",
          "2024A_",
          "A24_",
          "A_24_",
          "A2024_",
          "2024_A_",
          "A_2024_",
        ];
        const keys = Object.keys(rec || {});
        for (const pref of candidates) {
          if (keys.some((k) => k.startsWith(pref))) return pref;
        }
        const maybe = keys.find((k) => /24.*A|A.*24/i.test(k));
        if (maybe) {
          const idx = maybe.lastIndexOf("_");
          if (idx > 0) return maybe.slice(0, idx + 1);
        }
        return null;
      }

      function detectTotalKey(rec, pref) {
        if (!rec || !pref) return null;
        const keys = Object.keys(rec);
        const exact = `${pref}TOTAL`;
        if (keys.includes(exact)) return exact;
        return (
          keys.find((k) => k.startsWith(pref) && /TOTAL|TOT/i.test(k)) || null
        );
      }

      function detectLNKey(rec, pref) {
        if (!rec || !pref) return null;
        const keys = Object.keys(rec);
        const exact = `${pref}LN`;
        if (keys.includes(exact)) return exact;
        return (
          keys.find((k) => k.startsWith(pref) && /LN|LISTA/i.test(k)) || null
        );
      }

      function getPartiesFromARecord(rec) {
        const pref = detectA2024Prefix(rec);
        if (!pref) return [];
        const keys = Object.keys(rec || {});
        const partyKeys = keys.filter(
          (k) =>
            k.startsWith(pref) &&
            !/(TOTAL|TOT|LN|LISTA)/i.test(k.slice(pref.length))
        );
        return partyKeys.map((k) => k.slice(pref.length));
      }

      function computeMarginFromA2024(rec) {
        if (!rec)
          return { margen: 0, total: 0, first: null, second: null, pref: null };
        const pref = detectA2024Prefix(rec);
        if (!pref)
          return { margen: 0, total: 0, first: null, second: null, pref: null };
        const totalKey = detectTotalKey(rec, pref);
        const total = totalKey ? toNum(rec[totalKey]) : 0;

        const parties = getPartiesFromARecord(rec);
        const arr = parties
          .map((p) => ({ p, v: toNum(rec[`${pref}${p}`]) }))
          .sort((a, b) => b.v - a.v);

        const v1 = arr[0]?.v ?? 0;
        const v2 = arr[1]?.v ?? 0;
        const first = arr[0]?.p ?? null;
        const second = arr[1]?.p ?? null;

        const margen = total > 0 ? (v1 - v2) / total : 0;
        return { margen, total, first, second, pref };
      }

      function computeParticipacion(rec) {
        const keys = Object.keys(rec || {});
        const kPart = keys.find((k) => /PARTICIPACION/i.test(k));
        if (kPart) {
          const n = toNum(rec[kPart]);
          if (n > 0 && n <= 1) return n;
          if (n > 1 && n <= 100) return n / 100;
        }
        const pref = detectA2024Prefix(rec);
        if (!pref) return 0;
        const totalKey = detectTotalKey(rec, pref);
        const lnKey = detectLNKey(rec, pref);
        const total = totalKey ? toNum(rec[totalKey]) : 0;
        const ln = lnKey ? toNum(rec[lnKey]) : 0;
        if (total > 0 && ln > 0) {
          const p = total / ln;
          return Math.max(0, Math.min(1, p));
        }
        return 0;
      }

      function computeFragmentacion(rec) {
        const m = computeMarginFromA2024(rec);
        if (!rec || !m.pref) return "‚Äî";
        const pref = m.pref;
        const totalKey = detectTotalKey(rec, pref);
        const total = totalKey ? toNum(rec[totalKey]) : 0;
        if (total <= 0) return "‚Äî";

        const parties = getPartiesFromARecord(rec);
        const arr = parties
          .map((p) => toNum(rec[`${pref}${p}`]))
          .sort((a, b) => b - a);
        const v1 = arr[0] ?? 0;
        const v2 = arr[1] ?? 0;
        const v3 = arr[2] ?? 0;
        const s1 = v1 / total;
        const d12 = (v1 - v2) / total;
        const d23 = (v2 - v3) / total;

        if (s1 < 0.35 && d12 < 0.06) return "ALTA";
        if (s1 < 0.45 && (d12 < 0.1 || d23 < 0.08)) return "MEDIA";
        return "BAJA";
      }

      /**************************************************************
       * Socio labels
       **************************************************************/
      function socioLabels(seccionKey) {
        const s = CCT_DATA.socio?.[seccionKey];
        if (!s) {
          return {
            perfil_demografico: "‚Äî",
            nivel_educativo: "‚Äî",
            presion_economica: "‚Äî",
            deficit_servicios: "‚Äî",
            conectividad: "‚Äî",
          };
        }

        const pobTotal = toNum(s.POB_TOTAL);
        const pob1517 = toNum(s.POB_15_17);
        const esc = toNum(s.ESCOLARIDAD_PROM);
        const pea = toNum(s.PEA_12MAS);
        const des = toNum(s.DESOCUPADOS_12MAS);

        const vivRef = Math.max(1, toNum(s.VIV_CON_ELECTRICIDAD));
        const cobAgua = toNum(s.VIV_CON_AGUA) / vivRef;
        const cobDren = toNum(s.VIV_CON_DRENAJE) / vivRef;
        const internet = toNum(s.VIV_CON_INTERNET) / vivRef;

        const ratioJoven = pobTotal > 0 ? pob1517 / pobTotal : 0;
        const tasaDes = pea > 0 ? des / pea : 0;

        const perfil_demografico =
          ratioJoven > 0.07 ? "JOVEN" : ratioJoven >= 0.04 ? "MIXTO" : "ADULTO";

        const nivel_educativo =
          esc < 8.5 ? "BAJO" : esc <= 10 ? "MEDIO" : "ALTO";

        const presion_economica =
          tasaDes > 0.03 ? "ALTA" : tasaDes >= 0.015 ? "MEDIA" : "BAJA";

        const deficit_servicios =
          cobAgua < 0.95 || cobDren < 0.95
            ? "ALTO"
            : cobAgua < 0.98 || cobDren < 0.98
            ? "MEDIO"
            : "BAJO";

        const conectividad =
          internet < 0.35 ? "BAJA" : internet <= 0.55 ? "MEDIA" : "ALTA";

        return {
          perfil_demografico,
          nivel_educativo,
          presion_economica,
          deficit_servicios,
          conectividad,
        };
      }

      /**************************************************************
       * Prompt + Brief Ejecutivo
       **************************************************************/
      function buildPrompt(payload) {
        return `
Eres un asistente estrat√©gico de comunicaci√≥n pol√≠tica territorial.
Trabajas para un candidato INDEPENDIENTE en una campa√±a local.

Tu tarea NO es persuadir ideol√≥gicamente, sino:
- interpretar datos territoriales reales
- traducirlos en mensajes ciudadanos
- proponer acciones de campa√±a y contenido para redes

CONTEXTO GENERAL:
- Municipio: ${payload.MUNICIPIO}
- Secci√≥n electoral: ${payload.SECCION}
- Tipo de secci√≥n: ${payload.TIPO_SECCION} (BASE / COMPETIDA / RECUPERACION)
- Etapa: ${payload.ETAPA} (PRECAMPA√ëA / CAMPA√ëA)

PERFIL SOCIOECON√ìMICO (resumido):
- Perfil demogr√°fico: ${payload.SOCIO_RESUMEN.perfil_demografico}
- Nivel educativo: ${payload.SOCIO_RESUMEN.nivel_educativo}
- Presi√≥n econ√≥mica: ${payload.SOCIO_RESUMEN.presion_economica}
- D√©ficit de servicios b√°sicos: ${payload.SOCIO_RESUMEN.deficit_servicios}
- Conectividad digital: ${payload.SOCIO_RESUMEN.conectividad}

REGLAS ESTRICTAS:
1. NO inventes datos ni cifras.
2. NO prometas obras, programas o soluciones espec√≠ficas.
3. NO ataques partidos ni personas.
4. Usa lenguaje ciudadano, cercano y territorial.
5. Enfoque de escucha, cercan√≠a y soluci√≥n colectiva.
6. Coherente con un candidato independiente.

TAREA:
Genera un BRIEF DE CONTENIDO TERRITORIAL con la siguiente estructura EXACTA:

1) DIAGN√ìSTICO TERRITORIAL (m√°x. 3 l√≠neas)
2) OBJETIVO DE COMUNICACI√ìN
3) MENSAJE CLAVE
4) QU√â DECIR (3 bullets)
5) QU√â EVITAR
6) TIPO DE EVENTO RECOMENDADO
7) CONTENIDO PARA REDES
   a) Copy corto (m√°x. 3 l√≠neas)
   b) Guion breve para video (20‚Äì30 segundos)
   c) Llamado a la acci√≥n (CTA)
8) PLATAFORMA Y FORMATO SUGERIDO

FORMATO:
- Claro, concreto y accionable.
- No agregues secciones extras.
`.trim();
      }

      function buildBriefEjecutivo(payload) {
        // Un brief ‚Äúcandidato-friendly‚Äù basado en etiquetas (sin inventar datos)
        const tipo = payload.TIPO_SECCION;
        const soc = payload.SOCIO_RESUMEN;

        // Mensaje base (sin prometer obras)
        let foco = "escuchar y resolver con la gente";
        if (soc.deficit_servicios === "ALTO")
          foco = "servicios b√°sicos y calidad de vida";
        else if (soc.presion_economica === "ALTA")
          foco = "empleo, ingresos y oportunidades";
        else if (soc.conectividad === "BAJA")
          foco = "presencia en calle y comunicaci√≥n directa";
        else if (soc.nivel_educativo === "ALTO")
          foco = "propuestas claras y acuerdos comunitarios";

        let objetivo = "reconectar";
        if (tipo === "RECUPERACION")
          objetivo = "persuadir y recuperar confianza";
        if (tipo === "COMPETIDA") objetivo = "persuadir y movilizar";
        if (tipo === "BASE") objetivo = "movilizar y consolidar";

        const formato = payload.REGLAS_TONO.formato;
        const evento =
          formato === "evento"
            ? "Recorrido + mini asamblea (30‚Äì45 min)"
            : formato === "video_corto"
            ? "Grabaci√≥n en calle + micro-entrevista (20‚Äì30s)"
            : "Mensaje con foto real + texto corto";

        const plataforma =
          soc.conectividad === "ALTA"
            ? "Facebook + Reels"
            : soc.conectividad === "MEDIA"
            ? "Facebook + WhatsApp"
            : "WhatsApp + presencia territorial";

        return `
BRIEF EJECUTIVO ‚Äî SECCI√ìN ${payload.SECCION} (${payload.TIPO_SECCION})

Diagn√≥stico r√°pido:
- Perfil: ${soc.perfil_demografico} ¬∑ Educaci√≥n: ${
          soc.nivel_educativo
        } ¬∑ Econom√≠a: ${soc.presion_economica}
- Servicios: ${soc.deficit_servicios} ¬∑ Conectividad: ${soc.conectividad}

Objetivo:
- ${objetivo.toUpperCase()} (enfoque: ${payload.REGLAS_TONO.enfoque})

Mensaje clave:
- ‚ÄúAqu√≠ venimos a ${foco}, con cercan√≠a y soluciones construidas con ustedes.‚Äù

Qu√© decir (3 ideas):
- ‚ÄúQuiero escuchar qu√© urge en esta zona y priorizarlo con ustedes.‚Äù
- ‚ÄúMi compromiso es estar presente, dar seguimiento y rendir cuentas.‚Äù
- ‚ÄúLa soluci√≥n se construye con la comunidad: organizaci√≥n, gesti√≥n y resultados.‚Äù

Qu√© evitar:
- Promesas de obras espec√≠ficas y ataques a partidos/personas.

Evento recomendado:
- ${evento}

Redes (enfoque ${payload.REGLAS_TONO.tono}):
- Plataforma sugerida: ${plataforma}
- CTA: ‚ÄúS√∫mate: comparte tu necesidad y participa en la agenda local.‚Äù
`.trim();
      }

      /**************************************************************
       * Build payload
       **************************************************************/
      function buildPayload(seccionKey) {
        const recA = CCT_DATA.electoralA?.[seccionKey] || {};
        const m = computeMarginFromA2024(recA);
        const margenPts = m.margen * 100;
        const tipo = classifyTipoSeccion(margenPts);

        const socio = socioLabels(seccionKey);
        const participacion = computeParticipacion(recA);
        const frag = computeFragmentacion(recA);
        const ganadorCalc = m.first ? String(m.first) : "‚Äî";

        return {
          MUNICIPIO: CCT_CFG.municipio,
          SECCION: String(seccionKey),
          ETAPA: $("selEtapa").value,
          PUESTO_BASE: "A",
          ANIO_BASE: 2024,
          TIPO_SECCION: tipo,
          ELECTORAL_RESUMEN: {
            participacion: participacion,
            ganador:
              recA["GANADOR_24A"] ?? recA["GANADOR_2024_A"] ?? ganadorCalc,
            margen_pct: Number.isFinite(margenPts)
              ? Number(margenPts.toFixed(1))
              : 0,
            competitividad: tipo,
            fragmentacion: frag,
          },
          SOCIO_RESUMEN: {
            perfil_demografico: socio.perfil_demografico,
            nivel_educativo: socio.nivel_educativo,
            presion_economica: socio.presion_economica,
            deficit_servicios: socio.deficit_servicios,
            conectividad: socio.conectividad,
          },
          REGLAS_TONO: {
            tono: $("selTono").value,
            enfoque: $("selEnfoque").value,
            formato: $("selFormato").value,
            prohibido: [
              "inventar cifras",
              "prometer obras espec√≠ficas",
              "atacar partidos o personas",
            ],
          },
        };
      }

      /**************************************************************
       * Map init + layers
       **************************************************************/
      let map, seccionesLayer, highlightLayer;

      function mapStyleDefault() {
        return {
          weight: 1,
          opacity: 0.9,
          color: "rgba(31,75,90,.55)",
          fillOpacity: 0.06,
        };
      }
      function mapStyleHover() {
        return {
          weight: 2,
          opacity: 1,
          color: "rgba(31,75,90,.95)",
          fillOpacity: 0.1,
        };
      }
      function mapStyleHighlight() {
        return {
          weight: 4,
          opacity: 1,
          color: "rgba(31,75,90,1)",
          fillOpacity: 0.12,
        };
      }

      function initMap() {
        map = L.map("cctMap", { zoomControl: true }).setView(
          [20.45, -101.53],
          12
        );

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);

        highlightLayer = L.geoJSON(null, { style: mapStyleHighlight }).addTo(
          map
        );

        seccionesLayer = L.geoJSON(CCT_DATA.geo, {
          style: mapStyleDefault,
          onEachFeature: (feature, layer) => {
            const sec = String(feature.properties?.SECCION ?? "").trim();

            layer.bindTooltip(`Secci√≥n ${sec}`, {
              sticky: true,
              opacity: 0.92,
            });

            layer.on("mouseover", () => layer.setStyle(mapStyleHover()));
            layer.on("mouseout", () => layer.setStyle(mapStyleDefault()));

            layer.on("click", () => selectSection(sec, feature, layer));
          },
        }).addTo(map);

        map.fitBounds(seccionesLayer.getBounds(), { padding: [26, 26] });

        $("btnFitAll").addEventListener("click", () =>
          map.fitBounds(seccionesLayer.getBounds(), { padding: [26, 26] })
        );
        $("btnClearSel").addEventListener("click", clearSelection);
        $("btnClearSel").addEventListener("dblclick", clearSelection);
        $("btnClearSel").addEventListener("contextmenu", (e) => {
          e.preventDefault();
          clearSelection();
        });

        $("btnFitAll").addEventListener("dblclick", () =>
          map.fitBounds(seccionesLayer.getBounds(), { padding: [34, 34] })
        );
        $("btnFitAll").addEventListener("contextmenu", (e) => {
          e.preventDefault();
          map.fitBounds(seccionesLayer.getBounds(), { padding: [34, 34] });
        });

        $("btnClearSel").title = "Limpiar selecci√≥n (doble clic para asegurar)";
      }

      function clearSelection() {
        highlightLayer.clearLayers();
        $("hudSec").textContent = "‚Äî";
        setChip($("hudTipo"), "‚Äî");
        $("hudMargen").textContent = "‚Äî";
        setChip($("hudConn"), "‚Äî");

        $("valTipo").textContent = "‚Äî";
        $("valMargen").textContent = "‚Äî";
        setChip($("chipStatus"), "Selecciona secci√≥n");

        // limpia salidas
        $("outPayload").textContent = "";
        $("outPrompt").textContent = "";
        $("outBrief").textContent = "";

        // tabs diag/plan
        $("dGanador").textContent = "‚Äî";
        $("dPart").textContent = "‚Äî";
        $("dFrag").textContent = "‚Äî";
        $("dComp").textContent = "‚Äî";

        $("sDemo").textContent = "‚Äî";
        $("sEdu").textContent = "‚Äî";
        $("sEco").textContent = "‚Äî";
        $("sConn").textContent = "‚Äî";
        $("sServ").textContent = "‚Äî";

        $("diagNarrativa").textContent = "";
        $("planTexto").textContent = "";
      }

      /**************************************************************
       * Section selection -> zoom + highlight + UI update
       **************************************************************/
      function selectSection(sec, feature, layer) {
        const key = String(sec).trim();
        $("selSeccion").value = key;

        highlightLayer.clearLayers();
        highlightLayer.addData(feature);
        map.fitBounds(layer.getBounds(), { padding: [34, 34] });

        // Update quick computed metrics (electoral + socio)
        const recA = CCT_DATA.electoralA?.[key] || {};
        const m = computeMarginFromA2024(recA);
        const margenPts = m.margen * 100;
        const tipo = classifyTipoSeccion(margenPts);
        const [tipoTxt, tipoLvl] = tipoChip(tipo);

        const socio = socioLabels(key);
        const conn = socio.conectividad;

        // HUD
        $("hudSec").textContent = key;
        setChip($("hudTipo"), tipoTxt, tipoLvl);
        $("hudMargen").textContent = Number.isFinite(margenPts)
          ? `${margenPts.toFixed(1)}%`
          : "‚Äî";
        setChip(
          $("hudConn"),
          conn,
          conn === "ALTA" ? "ok" : conn === "MEDIA" ? "warn" : "bad"
        );

        // Panel values
        $("valTipo").textContent = tipoTxt;
        $("valMargen").textContent = Number.isFinite(margenPts)
          ? `${margenPts.toFixed(1)}%`
          : "‚Äî";
        setChip($("chipStatus"), `Secci√≥n activa: ${key}`, "ok");

        // Diag quick
        const participacion = computeParticipacion(recA);
        const frag = computeFragmentacion(recA);
        const ganador =
          recA["GANADOR_24A"] ??
          recA["GANADOR_2024_A"] ??
          (m.first ? String(m.first) : "‚Äî");

        $("dGanador").textContent = ganador;
        $("dPart").textContent = participacion
          ? `${(participacion * 100).toFixed(1)}%`
          : "‚Äî";
        $("dFrag").textContent = frag;
        $("dComp").textContent = tipoTxt;

        $("sDemo").textContent = socio.perfil_demografico;
        $("sEdu").textContent = socio.nivel_educativo;
        $("sEco").textContent = socio.presion_economica;
        $("sConn").textContent = socio.conectividad;
        $("sServ").textContent = socio.deficit_servicios;

        $("diagNarrativa").textContent = buildDiagNarrativa(key, tipo, socio);
        $("planTexto").textContent = buildPlanAccion(key, tipo, socio);

        // opcional: autogenerar salidas al seleccionar
        // generateOutputs();
      }

      function buildDiagNarrativa(sec, tipo, socio) {
        const piezas = [];
        piezas.push(`SECCI√ìN ${sec} ‚Äî ${tipo}`);
        piezas.push(
          `Perfil: ${socio.perfil_demografico} ¬∑ Educaci√≥n: ${socio.nivel_educativo} ¬∑ Econom√≠a: ${socio.presion_economica}`
        );
        piezas.push(
          `Servicios: ${socio.deficit_servicios} ¬∑ Conectividad: ${socio.conectividad}`
        );
        piezas.push("");
        piezas.push("Lectura territorial:");
        piezas.push(
          `- Mensaje debe ser ${
            socio.nivel_educativo === "BAJO"
              ? "simple, directo y con ejemplos"
              : "claro, ordenado y con propuestas concretas sin prometer obras"
          }.`
        );
        piezas.push(
          `- Operaci√≥n recomendada: ${
            socio.conectividad === "BAJA"
              ? "territorio presencial + WhatsApp"
              : socio.conectividad === "MEDIA"
              ? "mixto (FB + WhatsApp + calle)"
              : "digital fuerte (FB/Reels) + calle"
          }.`
        );
        piezas.push(
          `- Intensidad: ${
            tipo === "RECUPERACION"
              ? "alta (convencer + presencia)"
              : tipo === "COMPETIDA"
              ? "alta (persuadir + movilizar)"
              : "media (consolidar + movilizar)"
          }.`
        );
        return piezas.join("\n");
      }

      function buildPlanAccion(sec, tipo, socio) {
        const l = [];
        l.push(`PLAN DE ACCI√ìN ‚Äî SECCI√ìN ${sec}`);
        l.push("");

        // Operaci√≥n
        l.push("OPERACI√ìN (campo):");
        if (tipo === "RECUPERACION") {
          l.push(
            "- Prioridad ALTA: presencia constante, escucha activa y seguimiento."
          );
          l.push(
            "- Recorrido + micro-asamblea (30‚Äì45 min) con compromisos de gesti√≥n (sin prometer obras)."
          );
        } else if (tipo === "COMPETIDA") {
          l.push(
            "- Prioridad ALTA: persuadir + movilizar con mensajes claros y cercanos."
          );
          l.push(
            "- Evento peque√±o + visitas focalizadas en puntos de afluencia."
          );
        } else {
          l.push("- Prioridad MEDIA: consolidar y asegurar participaci√≥n.");
          l.push("- Brigada ligera + llamada a la participaci√≥n.");
        }

        l.push("");
        l.push("MENSAJE (l√≠nea):");
        if (socio.deficit_servicios === "ALTO")
          l.push(
            "- Enfoque: servicios y calidad de vida (gesti√≥n + seguimiento + cercan√≠a)."
          );
        else if (socio.presion_economica === "ALTA")
          l.push(
            "- Enfoque: empleo/ingresos y oportunidades (apoyo local + puertas abiertas)."
          );
        else
          l.push(
            "- Enfoque: organizaci√≥n comunitaria y soluciones con la gente."
          );

        l.push("");
        l.push("REDES (formato):");
        if (socio.conectividad === "ALTA") {
          l.push(
            "- Reels 20‚Äì30s + post FB con foto real. 3 publicaciones/semana en esta zona."
          );
        } else if (socio.conectividad === "MEDIA") {
          l.push(
            "- FB + WhatsApp: post corto + video 20‚Äì30s; difusi√≥n por grupos."
          );
        } else {
          l.push(
            "- WhatsApp + calle: texto breve y foto real; reforzar presencial."
          );
        }

        l.push("");
        l.push("CHECKLIST (hoy):");
        l.push("- Definir 1 punto de reuni√≥n y 2 rutas cortas.");
        l.push("- Capturar 5 necesidades reales (frases de la gente).");
        l.push(
          "- Grabar 1 video corto con cierre (CTA) y 1 foto de interacci√≥n real."
        );
        return l.join("\n");
      }

      /**************************************************************
       * Tabs
       **************************************************************/
      document.querySelectorAll(".tab").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".tab")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tab;
          ["brief", "diag", "plan", "hist"].forEach((t) => {
            $(`tab_${t}`).style.display = t === tab ? "flex" : "none";
          });
          if (tab === "hist") renderHistory();
        });
      });

      /**************************************************************
       * Generate outputs
       **************************************************************/
      function generateOutputs() {
        const sec = $("selSeccion").value;
        if (!sec) {
          alert("Selecciona una secci√≥n (clic en mapa).");
          return;
        }
        const payload = buildPayload(sec);
        const prompt = buildPrompt(payload);
        const brief = buildBriefEjecutivo(payload);

        $("outPayload").textContent = JSON.stringify(payload, null, 2);
        $("outPrompt").textContent = prompt;
        $("outBrief").textContent = brief;

        // refresca hud/tipo panel si cambiaste controles
        const [tTxt, tLvl] = tipoChip(payload.TIPO_SECCION);
        $("valTipo").textContent = tTxt;
        setChip($("hudTipo"), tTxt, tLvl);
        setChip($("chipStatus"), `Listo: Payload + Prompt`, "ok");

        // diag/plan
        $("diagNarrativa").textContent = buildDiagNarrativa(
          sec,
          payload.TIPO_SECCION,
          payload.SOCIO_RESUMEN
        );
        $("planTexto").textContent = buildPlanAccion(
          sec,
          payload.TIPO_SECCION,
          payload.SOCIO_RESUMEN
        );
      }

      $("btnGenerar").addEventListener("click", () => {
        if (isAuthed()) generateOutputs();
      });
      $("btnCopyPayload").addEventListener("click", () =>
        copyText($("outPayload").textContent)
      );
      $("btnCopyPrompt").addEventListener("click", () =>
        copyText($("outPrompt").textContent)
      );
      $("btnCopyBrief").addEventListener("click", () =>
        copyText($("outBrief").textContent)
      );
      $("btnCopyPlan").addEventListener("click", () =>
        copyText($("planTexto").textContent)
      );

      /**************************************************************
       * History (localStorage)
       **************************************************************/
      const HIST_KEY = "CCT_ABASOLO_HISTORY_V1";

      function getHistory() {
        try {
          const raw = localStorage.getItem(HIST_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          return [];
        }
      }
      function setHistory(arr) {
        localStorage.setItem(HIST_KEY, JSON.stringify(arr));
      }

      function saveToHistory() {
        const sec = $("selSeccion").value;
        if (!sec || !$("outPayload").textContent) {
          alert("Genera primero el payload/prompt.");
          return;
        }
        const entry = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
          at: nowISO(),
          seccion: sec,
          payload: $("outPayload").textContent,
          prompt: $("outPrompt").textContent,
          brief: $("outBrief").textContent,
        };
        const arr = getHistory();
        arr.unshift(entry);
        setHistory(arr);
        setChip($("chipStatus"), "Guardado en historial", "ok");
        $("histCount").textContent = String(arr.length);
      }

      function renderHistory() {
        const arr = getHistory();
        $("histCount").textContent = String(arr.length);
        const wrap = $("histList");
        wrap.innerHTML = "";

        if (!arr.length) {
          wrap.innerHTML = `<div class="histItem"><div class="histHead">
          <div class="hTitle">Sin registros</div><div class="hMeta">‚Äî</div></div>
          <div class="hint">Genera un brief y presiona ‚ÄúGuardar en historial‚Äù.</div></div>`;
          return;
        }

        for (const it of arr.slice(0, 60)) {
          const div = document.createElement("div");
          div.className = "histItem";
          div.innerHTML = `
          <div class="histHead">
            <div class="hTitle">Secci√≥n ${it.seccion}</div>
            <div class="hMeta">${it.at}</div>
          </div>
          <div class="histBtns">
            <button class="smallBtn" data-act="load" data-id="${it.id}">Cargar</button>
            <button class="smallBtn" data-act="copyBrief" data-id="${it.id}">Copiar brief</button>
            <button class="smallBtn" data-act="copyPrompt" data-id="${it.id}">Copiar prompt</button>
            <button class="smallBtn" data-act="del" data-id="${it.id}">Eliminar</button>
          </div>
        `;
          wrap.appendChild(div);
        }

        wrap.querySelectorAll("button[data-act]").forEach((b) => {
          b.addEventListener("click", () => {
            const act = b.dataset.act;
            const id = b.dataset.id;
            const arr2 = getHistory();
            const found = arr2.find((x) => x.id === id);
            if (!found) return;

            if (act === "load") {
              $("selSeccion").value = found.seccion;
              $("outPayload").textContent = found.payload;
              $("outPrompt").textContent = found.prompt;
              $("outBrief").textContent = found.brief;
              setChip(
                $("chipStatus"),
                `Cargado: secci√≥n ${found.seccion}`,
                "ok"
              );
            }
            if (act === "copyBrief") copyText(found.brief);
            if (act === "copyPrompt") copyText(found.prompt);
            if (act === "del") {
              const next = arr2.filter((x) => x.id !== id);
              setHistory(next);
              renderHistory();
            }
          });
        });
      }

      $("btnGuardar").addEventListener("click", () => {
        if (isAuthed()) saveToHistory();
      });
      $("btnHistRefresh").addEventListener("click", renderHistory);
      $("btnHistClear").addEventListener("click", () => {
        if (!confirm("¬øBorrar TODO el historial local del CCT?")) return;
        setHistory([]);
        renderHistory();
      });

      /**************************************************************
       * PDF export (jsPDF simple)
       **************************************************************/
      function exportPdf({ mode }) {
        const sec = $("selSeccion").value;
        if (!sec || !$("outBrief").textContent) {
          alert("Genera primero el brief.");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "letter" });
        const margin = 40;
        let y = 50;

        const line = (txt, size = 11, bold = false) => {
          doc.setFont("helvetica", bold ? "bold" : "normal");
          doc.setFontSize(size);
          const lines = doc.splitTextToSize(txt, 540);
          for (const ln of lines) {
            if (y > 760) {
              doc.addPage();
              y = 50;
            }
            doc.text(ln, margin, y);
            y += size + 6;
          }
        };

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text(
          `CCT Abasolo ‚Äî ${mode === "exec" ? "PDF Ejecutivo" : "PDF Completo"}`,
          margin,
          y
        );
        y += 18;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Secci√≥n: ${sec} ¬∑ Fecha: ${nowISO()}`, margin, y);
        y += 18;

        line("BRIEF EJECUTIVO:", 12, true);
        line($("outBrief").textContent, 10, false);
        y += 8;

        if (mode === "full") {
          line("PAYLOAD (JSON):", 12, true);
          line($("outPayload").textContent || "", 8, false);
          y += 8;

          line("PROMPT MAESTRO:", 12, true);
          line($("outPrompt").textContent || "", 8, false);
        }

        doc.save(
          `CCT_ABASOLO_${sec}_${mode === "exec" ? "EJECUTIVO" : "COMPLETO"}.pdf`
        );
      }

      $("btnPdfEjecutivo").addEventListener("click", () =>
        exportPdf({ mode: "exec" })
      );
      $("btnPdfCompleto").addEventListener("click", () =>
        exportPdf({ mode: "full" })
      );

      /**************************************************************
       * Wiring select + initial boot
       **************************************************************/
      function fillSecciones() {
        const feats = (CCT_DATA.geo?.features || [])
          .map((f) => String(f.properties?.SECCION ?? "").trim())
          .filter(Boolean);

        const uniq = Array.from(new Set(feats)).sort(
          (a, b) => Number(a) - Number(b)
        );

        const sel = $("selSeccion");
        sel.innerHTML =
          `<option value="">‚Äî Selecciona ‚Äî</option>` +
          uniq.map((s) => `<option value="${s}">${s}</option>`).join("");
        sel.addEventListener("change", () => {
          const v = sel.value;
          if (!v) return;
          // buscar layer y disparar selecci√≥n
          let target = null;
          seccionesLayer.eachLayer((l) => {
            const s = String(l.feature?.properties?.SECCION ?? "").trim();
            if (s === v) target = l;
          });
          if (target) selectSection(v, target.feature, target);
        });
      }

      /**************************************************************
       * Boot
       **************************************************************/
      (async function boot() {
        try {
          await loadAll();
          initMap();
          fillSecciones();
          renderHistory();
        } catch (err) {
          console.error("CCT boot error:", err);
          alert(
            "CCT: Error cargando datos. Revisa consola (F12) y rutas en CCT_CFG.paths."
          );
        }
      })();
    </script>
  </body>
</html>
